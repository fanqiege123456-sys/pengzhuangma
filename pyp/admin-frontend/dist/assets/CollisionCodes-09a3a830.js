import{_ as ze,u as $e,k as Re,r as c,b as Se,M as Be,c as i,U as De,o as y,d as B,f as t,w as l,V as C,E as u,e as r,h as x,i as s,g as Te,n as D,t as v,a0 as T,W as Ue,a1 as Fe,p as M,A as Ae,$ as Ne,Y as qe,v as Ee,a2 as Me,D as Le}from"./index-1630d45c.js";const Ie={class:"collision-codes-page"},Ke={class:"page-header"},Pe={class:"header-actions"},Oe={class:"filter-section"},We={class:"action-bar"},Ye={class:"left-actions"},Ge={key:0,class:"right-actions"},He={class:"selected-count"},Je={class:"keyword-text"},Qe={class:"reject-reason"},Xe={key:1,class:"text-muted"},Ze={class:"action-btns"},et={class:"pagination-container"},tt={class:"reject-info"},lt={class:"reject-info"},at={__name:"CollisionCodes",setup(ot){const Q=$e(),L=Re(),U=c(!1),V=c([]),F=c(0),f=c([]),h=c(""),b=c(""),k=c(""),p=Se({page:1,pageSize:20,total:0}),j=c(!1),z=c(""),A=c(!1),N=c(null),$=c(!1),R=c(""),q=c(!1),X=a=>{if(!a)return"-";try{return new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return a}},Z=a=>({active:"success",expired:"warning",blackhole:"danger"})[a]||"info",ee=a=>({active:"活跃",expired:"过期",blackhole:"黑洞"})[a]||a||"-",te=a=>({approved:"success",rejected:"danger",pending:"warning"})[a]||"warning",le=a=>({approved:"通过",rejected:"拒绝",pending:"待审"})[a]||"待审",ae=a=>a.audit_status==="pending"||!a.audit_status,oe=a=>{f.value=a},g=async()=>{var a;U.value=!0;try{const e={page:p.page,page_size:p.pageSize};h.value&&(e.status=h.value),b.value&&(e.audit_status=b.value),k.value&&(e.keyword=k.value);const d=await C.get("/collisions",{params:e});if(d.data.code===200){const n=d.data.data;V.value=(n==null?void 0:n.list)||(n==null?void 0:n.records)||n||[],p.total=((a=n==null?void 0:n.pagination)==null?void 0:a.total)||(n==null?void 0:n.total)||V.value.length,F.value=(n==null?void 0:n.pending_count)||0}else V.value=[],p.total=0}catch(e){console.error("加载碰撞码失败:",e),u.error("加载碰撞码失败"),V.value=[]}finally{U.value=!1}},ne=()=>{g()},S=()=>{p.page=1,g()},se=()=>{h.value="",b.value="",k.value="",p.page=1,g()},re=()=>{b.value="pending",h.value="",k.value="",p.page=1,g()},ie=async a=>{try{await M.confirm(`确定通过「${a.tag}」的审核？`,"确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"success"});const e=await C.put(`/collisions/${a.id}/approve`);e.data.code===200?(u.success("审核通过"),g()):u.error(e.data.message||"操作失败")}catch(e){e!=="cancel"&&(console.error("审核失败:",e),u.error("操作失败"))}},ue=async()=>{if(f.value.length!==0)try{await M.confirm(`确定批量通过 ${f.value.length} 条碰撞码？`,"确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"success"});const a=f.value.map(d=>d.id),e=await C.put("/collisions/batch-approve",{ids:a});e.data.code===200?(u.success(`成功通过 ${a.length} 条`),f.value=[],g()):u.error(e.data.message||"操作失败")}catch(a){a!=="cancel"&&(console.error("批量通过失败:",a),u.error("操作失败"))}},de=a=>{N.value=a,z.value="",j.value=!0},ce=async()=>{if(!z.value.trim()){u.warning("请输入拒绝原因");return}A.value=!0;try{const a=await C.put(`/collisions/${N.value.id}/reject`,{reject_reason:z.value});a.data.code===200?(u.success("已拒绝"),j.value=!1,g()):u.error(a.data.message||"操作失败")}catch(a){console.error("拒绝失败:",a),u.error("操作失败")}finally{A.value=!1}},pe=()=>{R.value="",$.value=!0},ge=async()=>{if(!R.value.trim()){u.warning("请输入拒绝原因");return}q.value=!0;try{const a=f.value.map(d=>d.id),e=await C.put("/collisions/batch-reject",{ids:a,reject_reason:R.value});e.data.code===200?(u.success(`成功拒绝 ${a.length} 条`),$.value=!1,f.value=[],g()):u.error(e.data.message||"操作失败")}catch(a){console.error("批量拒绝失败:",a),u.error("操作失败")}finally{q.value=!1}},fe=async(a,e)=>{try{(await C.put(`/collisions/${a.id}/status`,{status:e})).data.code===200&&(u.success("状态更新成功"),g())}catch(d){console.error("更新状态失败:",d),u.error("操作失败")}},_e=async a=>{try{await M.confirm(`确定删除「${a.tag}」？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await C.delete(`/collisions/${a.id}`)).data.code===200&&(u.success("删除成功"),g())}catch(e){e!=="cancel"&&console.error("删除失败:",e)}},ve=()=>{p.page=1,g()},me=()=>{g()},we=()=>{Q.push("/audit-settings")};return Be(()=>{L.query.audit_status&&(b.value=L.query.audit_status),g()}),(a,e)=>{const d=i("el-icon"),n=i("el-button"),m=i("el-option"),I=i("el-select"),E=i("el-input"),ye=i("el-alert"),_=i("el-table-column"),K=i("el-tag"),be=i("el-tooltip"),P=i("el-dropdown-item"),Ce=i("el-dropdown-menu"),he=i("el-dropdown"),ke=i("el-table"),xe=i("el-pagination"),Ve=i("el-card"),O=i("el-form-item"),W=i("el-form"),Y=i("el-dialog"),je=De("loading");return y(),B("div",Ie,[t(Ve,null,{default:l(()=>[r("div",Ke,[e[13]||(e[13]=r("h2",null,"碰撞码管理",-1)),r("div",Pe,[t(n,{onClick:we},{default:l(()=>[t(d,null,{default:l(()=>[t(x(Ae))]),_:1}),e[11]||(e[11]=s(" 审核设置 ",-1))]),_:1}),t(n,{type:"primary",onClick:ne},{default:l(()=>[t(d,null,{default:l(()=>[t(x(Ne))]),_:1}),e[12]||(e[12]=s(" 刷新 ",-1))]),_:1})])]),r("div",Oe,[t(I,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=o=>h.value=o),placeholder:"状态筛选",clearable:"",onChange:S,style:{width:"120px"}},{default:l(()=>[t(m,{label:"全部状态",value:""}),t(m,{label:"活跃",value:"active"}),t(m,{label:"过期",value:"expired"}),t(m,{label:"黑洞",value:"blackhole"})]),_:1},8,["modelValue"]),t(I,{modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=o=>b.value=o),placeholder:"审核状态",clearable:"",onChange:S,style:{width:"120px"}},{default:l(()=>[t(m,{label:"全部审核",value:""}),t(m,{label:"待审核",value:"pending"}),t(m,{label:"已通过",value:"approved"}),t(m,{label:"已拒绝",value:"rejected"})]),_:1},8,["modelValue"]),t(E,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=o=>k.value=o),placeholder:"搜索关键词",clearable:"",style:{width:"180px"},onKeyup:Te(S,["enter"])},null,8,["modelValue"]),t(n,{type:"primary",onClick:S},{default:l(()=>[t(d,null,{default:l(()=>[t(x(qe))]),_:1}),e[14]||(e[14]=s(" 搜索 ",-1))]),_:1}),t(n,{onClick:se},{default:l(()=>[...e[15]||(e[15]=[s("重置",-1)])]),_:1})]),r("div",We,[r("div",Ye,[F.value>0?(y(),D(ye,{key:0,type:"warning","show-icon":"",closable:!1,style:{padding:"8px 16px"}},{title:l(()=>[r("span",null,[e[16]||(e[16]=s("有 ",-1)),r("strong",null,v(F.value),1),e[17]||(e[17]=s(" 条待审核",-1))]),t(n,{type:"warning",size:"small",link:"",onClick:re,style:{"margin-left":"8px"}},{default:l(()=>[...e[18]||(e[18]=[s("立即处理",-1)])]),_:1})]),_:1})):T("",!0)]),f.value.length>0?(y(),B("div",Ge,[r("span",He,"已选 "+v(f.value.length)+" 项",1),t(n,{type:"success",size:"small",onClick:ue},{default:l(()=>[t(d,null,{default:l(()=>[t(x(Ee))]),_:1}),e[19]||(e[19]=s(" 批量通过 ",-1))]),_:1}),t(n,{type:"danger",size:"small",onClick:pe},{default:l(()=>[t(d,null,{default:l(()=>[t(x(Me))]),_:1}),e[20]||(e[20]=s(" 批量拒绝 ",-1))]),_:1})])):T("",!0)]),Ue((y(),D(ke,{data:V.value,style:{width:"100%"},stripe:"",border:"",onSelectionChange:oe},{default:l(()=>[t(_,{type:"selection",width:"50",selectable:ae}),t(_,{prop:"id",label:"ID",width:"70",align:"center"}),t(_,{label:"关键词","min-width":"120"},{default:l(o=>[r("span",Je,v(o.row.tag||"-"),1)]),_:1}),t(_,{label:"用户","min-width":"130"},{default:l(o=>{var w,G,H,J;return[s(v(((w=o.row.user)==null?void 0:w.wechat_no)||((G=o.row.user)==null?void 0:G.phone)||((J=(H=o.row.user)==null?void 0:H.openid)==null?void 0:J.substring(0,10))||"-"),1)]}),_:1}),t(_,{label:"创建时间",width:"170",sortable:""},{default:l(o=>[s(v(X(o.row.created_at)),1)]),_:1}),t(_,{prop:"status",label:"状态",width:"80",align:"center"},{default:l(o=>[t(K,{type:Z(o.row.status),size:"small"},{default:l(()=>[s(v(ee(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),t(_,{label:"审核",width:"80",align:"center"},{default:l(o=>[t(K,{type:te(o.row.audit_status),size:"small"},{default:l(()=>[s(v(le(o.row.audit_status)),1)]),_:2},1032,["type"])]),_:1}),t(_,{label:"拒绝原因","min-width":"120"},{default:l(o=>[o.row.reject_reason?(y(),D(be,{key:0,content:o.row.reject_reason,placement:"top"},{default:l(()=>[r("span",Qe,v(o.row.reject_reason),1)]),_:2},1032,["content"])):(y(),B("span",Xe,"-"))]),_:1}),t(_,{prop:"cost_coins",label:"消耗",width:"70",align:"center"}),t(_,{label:"操作",fixed:"right",width:"200",align:"center"},{default:l(o=>[r("div",Ze,[o.row.audit_status==="pending"||!o.row.audit_status?(y(),B(Fe,{key:0},[t(n,{type:"success",size:"small",onClick:w=>ie(o.row)},{default:l(()=>[...e[21]||(e[21]=[s("通过",-1)])]),_:2},1032,["onClick"]),t(n,{type:"danger",size:"small",onClick:w=>de(o.row)},{default:l(()=>[...e[22]||(e[22]=[s("拒绝",-1)])]),_:2},1032,["onClick"])],64)):T("",!0),t(he,{trigger:"click"},{dropdown:l(()=>[t(Ce,null,{default:l(()=>[o.row.status!=="blackhole"?(y(),D(P,{key:0,onClick:w=>fe(o.row,"blackhole")},{default:l(()=>[...e[24]||(e[24]=[s(" 设为黑洞 ",-1)])]),_:2},1032,["onClick"])):T("",!0),t(P,{onClick:w=>_e(o.row),divided:""},{default:l(()=>[...e[25]||(e[25]=[r("span",{style:{color:"#F56C6C"}},"删除",-1)])]),_:2},1032,["onClick"])]),_:2},1024)]),default:l(()=>[t(n,{size:"small"},{default:l(()=>[e[23]||(e[23]=s(" 更多",-1)),t(d,{class:"el-icon--right"},{default:l(()=>[t(x(Le))]),_:1})]),_:1})]),_:2},1024)])]),_:1})]),_:1},8,["data"])),[[je,U.value]]),r("div",et,[t(xe,{"current-page":p.page,"onUpdate:currentPage":e[3]||(e[3]=o=>p.page=o),"page-size":p.pageSize,"onUpdate:pageSize":e[4]||(e[4]=o=>p.pageSize=o),"page-sizes":[10,20,50,100],total:p.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ve,onCurrentChange:me},null,8,["current-page","page-size","total"])])]),_:1}),t(Y,{modelValue:j.value,"onUpdate:modelValue":e[7]||(e[7]=o=>j.value=o),title:"拒绝碰撞码",width:"420px","close-on-click-modal":!1},{footer:l(()=>[t(n,{onClick:e[6]||(e[6]=o=>j.value=!1)},{default:l(()=>[...e[27]||(e[27]=[s("取消",-1)])]),_:1}),t(n,{type:"danger",onClick:ce,loading:A.value},{default:l(()=>[...e[28]||(e[28]=[s("确认拒绝",-1)])]),_:1},8,["loading"])]),default:l(()=>{var o;return[r("div",tt,[r("p",null,[e[26]||(e[26]=s("关键词：",-1)),r("strong",null,v((o=N.value)==null?void 0:o.tag),1)])]),t(W,null,{default:l(()=>[t(O,{label:"拒绝原因",required:""},{default:l(()=>[t(E,{modelValue:z.value,"onUpdate:modelValue":e[5]||(e[5]=w=>z.value=w),type:"textarea",rows:3,placeholder:"请输入拒绝原因，将展示给用户",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1})]}),_:1},8,["modelValue"]),t(Y,{modelValue:$.value,"onUpdate:modelValue":e[10]||(e[10]=o=>$.value=o),title:"批量拒绝",width:"420px","close-on-click-modal":!1},{footer:l(()=>[t(n,{onClick:e[9]||(e[9]=o=>$.value=!1)},{default:l(()=>[...e[31]||(e[31]=[s("取消",-1)])]),_:1}),t(n,{type:"danger",onClick:ge,loading:q.value},{default:l(()=>[...e[32]||(e[32]=[s("确认拒绝",-1)])]),_:1},8,["loading"])]),default:l(()=>[r("div",lt,[r("p",null,[e[29]||(e[29]=s("即将拒绝 ",-1)),r("strong",null,v(f.value.length),1),e[30]||(e[30]=s(" 条碰撞码",-1))])]),t(W,null,{default:l(()=>[t(O,{label:"拒绝原因",required:""},{default:l(()=>[t(E,{modelValue:R.value,"onUpdate:modelValue":e[8]||(e[8]=o=>R.value=o),type:"textarea",rows:3,placeholder:"请输入统一的拒绝原因",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},st=ze(at,[["__scopeId","data-v-8627eee4"]]);export{st as default};
